<!doctype html><html lang="zh-CN"><head><meta charset="utf-8" /><meta name="viewport" content="width=device-width,initial-scale=1" /><meta name="generator" content="VuePress 2.0.0-rc.23" /><meta name="theme" content="VuePress Theme Plume 1.0.0-rc.151" /><script id="check-mac-os">document.documentElement.classList.toggle('mac', /Mac|iPhone|iPod|iPad/i.test(navigator.platform))</script><script id="check-dark-mode">;(function () {const um= localStorage.getItem('vuepress-theme-appearance') || 'auto';const sm = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;const isDark = um === 'dark' || (um !== 'light' && sm);document.documentElement.dataset.theme = isDark ? 'dark' : 'light';})();</script><link rel="icon" type="image/png" href="zhishiku.png"><title>依赖 | 渔舟小站</title><meta name="description" content="渔舟的站点"><link rel="preload" href="/yuzhou-site/assets/style-BjADDtjt.css" as="style"><link rel="stylesheet" href="/yuzhou-site/assets/style-BjADDtjt.css"><link rel="modulepreload" href="/yuzhou-site/assets/app-Bg3bfEUT.js"><link rel="modulepreload" href="/yuzhou-site/assets/index.html-CyAl5_0H.js"></head><body><div id="app"><!--[--><!--[--><div class="theme-plume vp-layout" vp-container data-v-2cd99c61><!--[--><!--[--><!--]--><!--[--><span tabindex="-1" data-v-04aa07a2></span><a href="#VPContent" class="vp-skip-link visually-hidden" data-v-04aa07a2> Skip to content </a><!--]--><!----><header class="vp-nav" data-v-2cd99c61 data-v-cb84354d><div class="vp-navbar" vp-navbar data-v-cb84354d data-v-c8291bb3><div class="wrapper" data-v-c8291bb3><div class="container" data-v-c8291bb3><div class="title" data-v-c8291bb3><div class="vp-navbar-title" data-v-c8291bb3 data-v-aa9555db><a class="vp-link no-icon link title" href="/yuzhou-site/" data-v-aa9555db data-v-230c3d54><!--[--><!--[--><!--]--><!--[--><!--[--><!--[--><img class="vp-image dark logo" style="" src="/yuzhou-site/zhishiku.png" alt data-v-a653499d><!--]--><!--[--><img class="vp-image light logo" style="" src="/yuzhou-site/zhishiku.png" alt data-v-a653499d><!--]--><!--]--><!--]--><span data-v-aa9555db>渔舟小站</span><!--[--><!--]--><!--]--><!----></a></div></div><div class="content" data-v-c8291bb3><div class="content-body" data-v-c8291bb3><!--[--><!--]--><div class="vp-navbar-search search" data-v-c8291bb3><div class="search-wrapper" data-v-fbf9c935><!----><div id="local-search" data-v-fbf9c935><button type="button" class="mini-search mini-search-button" aria-label="搜索文档" data-v-fbf9c935><span class="mini-search-button-container"><span class="mini-search-search-icon vpi-mini-search" aria-label="search icon"></span><span class="mini-search-button-placeholder">搜索文档</span></span><span class="mini-search-button-keys"><kbd class="mini-search-button-key"></kbd><kbd class="mini-search-button-key">K</kbd></span></button></div></div></div><!--[--><!--]--><nav aria-labelledby="main-nav-aria-label" class="vp-navbar-menu menu" data-v-c8291bb3 data-v-a9676556><span id="main-nav-aria-label" class="visually-hidden" data-v-a9676556>Main Navigation</span><!--[--><!--[--><a class="vp-link no-icon link navbar-menu-link" href="/yuzhou-site/aboutme/" tabindex="0" data-v-a9676556 data-v-ae9c43c6 data-v-230c3d54><!--[--><!----><span data-v-ae9c43c6>关于我👩‍💼</span><!----><!--]--><!----></a><!--]--><!--[--><a class="vp-link no-icon link navbar-menu-link" href="/yuzhou-site/baseKnowledge/" tabindex="0" data-v-a9676556 data-v-ae9c43c6 data-v-230c3d54><!--[--><!----><span data-v-ae9c43c6>基础知识🧀</span><!----><!--]--><!----></a><!--]--><!--[--><a class="vp-link no-icon link navbar-menu-link" href="/yuzhou-site/sourceCode/" tabindex="0" data-v-a9676556 data-v-ae9c43c6 data-v-230c3d54><!--[--><!----><span data-v-ae9c43c6>源码学习📚</span><!----><!--]--><!----></a><!--]--><!--[--><a class="vp-link no-icon link navbar-menu-link" href="/yuzhou-site/practice/" tabindex="0" data-v-a9676556 data-v-ae9c43c6 data-v-230c3d54><!--[--><!----><span data-v-ae9c43c6>工作实践💻</span><!----><!--]--><!----></a><!--]--><!--[--><a class="vp-link no-icon link navbar-menu-link" href="/yuzhou-site/article/7j07ihxk/" tabindex="0" data-v-a9676556 data-v-ae9c43c6 data-v-230c3d54><!--[--><!----><span data-v-ae9c43c6>leetCode💡</span><!----><!--]--><!----></a><!--]--><!--[--><a class="vp-link no-icon link navbar-menu-link" href="/yuzhou-site/read/" tabindex="0" data-v-a9676556 data-v-ae9c43c6 data-v-230c3d54><!--[--><!----><span data-v-ae9c43c6>开卷有益📖</span><!----><!--]--><!----></a><!--]--><!--[--><a class="vp-link no-icon link navbar-menu-link" href="/yuzhou-site/blog/archives/" tabindex="0" data-v-a9676556 data-v-ae9c43c6 data-v-230c3d54><!--[--><!----><span data-v-ae9c43c6>归档</span><!----><!--]--><!----></a><!--]--><!--]--></nav><!--[--><!--]--><!----><div class="vp-navbar-appearance appearance" data-v-c8291bb3 data-v-49f87829><button class="vp-switch vp-switch-appearance" type="button" role="switch" title aria-checked="false" data-v-49f87829 data-v-6862ca98 data-v-1b8b485c><span class="check" data-v-1b8b485c><span class="icon" data-v-1b8b485c><!--[--><span class="vpi-sun sun" data-v-6862ca98></span><span class="vpi-moon moon" data-v-6862ca98></span><!--]--></span></span></button></div><div class="vp-social-links vp-navbar-social-links social-links" data-v-c8291bb3 data-v-3a832deb data-v-feba6c91><!--[--><a class="vp-social-link no-icon" href="https://github.com/onlylovefish/yuzhou-site" aria-label="github" target="_blank" rel="noopener" data-v-feba6c91 data-v-344f47ea><span class="vpi-social-github" /></a><!--]--></div><div class="vp-flyout vp-navbar-extra extra" data-v-c8291bb3 data-v-f8d57d5d data-v-10af6d48><button type="button" class="button" aria-haspopup="true" aria-expanded="false" aria-label="extra navigation" data-v-10af6d48><span class="vpi-more-horizontal icon" data-v-10af6d48></span></button><div class="menu" data-v-10af6d48><div class="vp-menu" data-v-10af6d48 data-v-de5eeab9><!----><!--[--><!--[--><!----><div class="group" data-v-f8d57d5d><div class="item appearance" data-v-f8d57d5d><p class="label" data-v-f8d57d5d>外观</p><div class="appearance-action" data-v-f8d57d5d><button class="vp-switch vp-switch-appearance" type="button" role="switch" title aria-checked="false" data-v-f8d57d5d data-v-6862ca98 data-v-1b8b485c><span class="check" data-v-1b8b485c><span class="icon" data-v-1b8b485c><!--[--><span class="vpi-sun sun" data-v-6862ca98></span><span class="vpi-moon moon" data-v-6862ca98></span><!--]--></span></span></button></div></div></div><div class="group" data-v-f8d57d5d><div class="item social-links" data-v-f8d57d5d><div class="vp-social-links social-links-list" data-v-f8d57d5d data-v-feba6c91><!--[--><a class="vp-social-link no-icon" href="https://github.com/onlylovefish/yuzhou-site" aria-label="github" target="_blank" rel="noopener" data-v-feba6c91 data-v-344f47ea><span class="vpi-social-github" /></a><!--]--></div></div></div><!--]--><!--]--></div></div></div><!--[--><!--]--><button type="button" class="vp-navbar-hamburger hamburger" aria-label="mobile navigation" aria-expanded="false" aria-controls="nav-screen" data-v-c8291bb3 data-v-7ad7fefd><span class="container" data-v-7ad7fefd><span class="top" data-v-7ad7fefd></span><span class="middle" data-v-7ad7fefd></span><span class="bottom" data-v-7ad7fefd></span></span></button></div></div></div></div><div class="divider" data-v-c8291bb3><div class="divider-line" data-v-c8291bb3></div></div></div><!----></header><div class="vp-local-nav fixed reached-top is-blog" data-v-2cd99c61 data-v-26fe2698><button class="hidden menu" disabled aria-expanded="false" aria-controls="SidebarNav" data-v-26fe2698><span class="vpi-align-left menu-icon" data-v-26fe2698></span><span class="menu-text" data-v-26fe2698>Menu</span></button><div class="vp-local-nav-outline-dropdown" style="--vp-vh:0px;" data-v-26fe2698 data-v-77ed75df><button data-v-77ed75df>返回顶部</button><!----></div></div><!----><!--[--><div id="VPContent" vp-content class="vp-content" data-v-2cd99c61 data-v-778f4e12><div class="vp-doc-container is-blog" data-v-778f4e12 data-v-0d2ffc47><!--[--><!--]--><div class="container" data-v-0d2ffc47><!----><div class="content" data-v-0d2ffc47><div class="content-container" data-v-0d2ffc47><!--[--><!--]--><main class="main" data-v-0d2ffc47><nav class="vp-breadcrumb" data-v-0d2ffc47 data-v-f5695888><ol vocab="https://schema.org/" typeof="BreadcrumbList" data-v-f5695888><!--[--><li property="itemListElement" typeof="ListItem" data-v-f5695888><a class="vp-link no-icon link breadcrumb" href="/yuzhou-site/" property="item" typeof="WebPage" data-v-f5695888 data-v-230c3d54><!--[-->首页<!--]--><!----></a><span class="vpi-chevron-right" data-v-f5695888></span><meta property="name" content="首页" data-v-f5695888><meta property="position" content="1" data-v-f5695888></li><li property="itemListElement" typeof="ListItem" data-v-f5695888><a class="vp-link no-icon link breadcrumb" href="/yuzhou-site/blog/" property="item" typeof="WebPage" data-v-f5695888 data-v-230c3d54><!--[-->博客<!--]--><!----></a><span class="vpi-chevron-right" data-v-f5695888></span><meta property="name" content="博客" data-v-f5695888><meta property="position" content="2" data-v-f5695888></li><li property="itemListElement" typeof="ListItem" data-v-f5695888><a class="vp-link no-icon link breadcrumb" href="/yuzhou-site/blog/categories/?id=8c4040" property="item" typeof="WebPage" data-v-f5695888 data-v-230c3d54><!--[-->practice<!--]--><!----></a><span class="vpi-chevron-right" data-v-f5695888></span><meta property="name" content="practice" data-v-f5695888><meta property="position" content="3" data-v-f5695888></li><li property="itemListElement" typeof="ListItem" data-v-f5695888><a class="vp-link no-icon link breadcrumb current" href="/yuzhou-site/practice/%E4%BE%9D%E8%B5%96/" property="item" typeof="WebPage" data-v-f5695888 data-v-230c3d54><!--[-->依赖<!--]--><!----></a><!----><meta property="name" content="依赖" data-v-f5695888><meta property="position" content="4" data-v-f5695888></li><!--]--></ol></nav><!--[--><!--]--><!--[--><h1 class="vp-doc-title page-title" data-v-bac073e1>依赖 <!----></h1><div class="vp-doc-meta" data-v-bac073e1><!--[--><!--]--><p class="reading-time" data-v-bac073e1><span class="vpi-books icon" data-v-bac073e1></span><span data-v-bac073e1>约 1467 字</span><span data-v-bac073e1>大约 5 分钟</span></p><!----><!--[--><!--]--><p class="create-time" data-v-bac073e1><span class="vpi-clock icon" data-v-bac073e1></span><span data-v-bac073e1>2025-07-27</span></p></div><!--]--><!--[--><!--]--><div class="_practice_%E4%BE%9D%E8%B5%96_ external-link-icon-enabled vp-doc plume-content" vp-content data-v-0d2ffc47><!--[--><!--]--><div data-v-0d2ffc47><p>本周我们仓库在做一个quickJS引擎的应用，需要升级基建cli，发现了几个问题，所以那就梳理下吧～</p><p>先说下问题</p><ol><li>当前仓库的monorepo结构下无法单包升级cli，会提示存在多版本共存问题，导致无法构建</li><li>其中试点子包会出现依赖的msi版本冗余打包问题</li><li>msi幽灵依赖问题</li></ol><p>我们的仓库之前做过一次monorepo的基建改造，部分包做了子包安装，有些又在根目录锁包，因为有些是迁移的整体依赖管理不是非常好</p><p>针对这几个问题做了下排查</p><p>先说第一个问题，无法单包升级cli，因为属于基建升级，所以是期望先在其中某些子包做试点，选择的这个子包，我们发现升级这个子包A的cli到3.1.9后，不仅这个子包A不能构建了，monorepo下其他子包无法构建了，排查发现因为这个项目下其实因为之前的升级和一些历史遗留问题，再加上我们这次又引入了一个版本，整个项目下存在多个cli版本，在cli中有个卡控,如下图所示</p><p><img src="/yuzhou-site/assets/cli%E5%8D%A1%E6%8E%A7%E6%88%AA%E5%9B%BE-D4pu4w9e.png" alt="alt text"></p><p>在多版本不匹配的情况下，会直接<code>process.exit(0)</code>,而不会接下去执行，看了下后面的执行流程，多版本对构建本身不存在影响，所以先对cli进行patch，将该部分的代码注释掉，并且添加一行打印，等所有子包升级后就不会存在多版本，自然也就不需要patch了</p><p>其实这里还存在一个问题，因为我们之前从3.0.4-7升级到3.0.8-rome.8并不需要给3.0.8-rome.8打patch，为什么这次需要呢，其实还是从上面截图中看，这里匹配用的是```semver.satisfies，这个函数对于小版本中的升级其实是不影响的，但是因为我们这里直接升级了中版本号，所以会走进这个if条件，从而命中卡控</p><p>问题2，msi的冗余打包</p><p>当前的cli工具中对于monorepo的支持不是很好，它无法寻找根目录的依赖，因为cli需要寻找rn依赖，我们这次的试点子包没有在子包的 <code>package.json</code>中直接依赖，实际用的算是幽灵依赖，用了根目录的rn <img src="/yuzhou-site/assets/%E5%AF%BB%E6%89%BErn%E6%8A%A5%E9%94%99-CWzUQZgA.png" alt="alt text"><img src="/yuzhou-site/assets/%E5%AF%BB%E6%89%BErn%E5%9C%B0%E5%9D%80%E7%9A%84%E4%BB%A3%E7%A0%81%E8%A1%8C-CK-f_iJh.png" alt="alt text"> 所以为了解决这个问题，和基建侧沟通，他们暂不修改，只能我们自己先解决，看了下只能我们在子包中安装rn</p><p>此时就引出了我们这个问题，构建后在sourcemap中发现msi出现了冗余打包，那这个是什么原因呢，我们发现有两个msi，其中一个是1.15.0一个是1.56.2-beta.0，看了这两个依赖的依赖发现他们的peerDev中有rn，而我们仓库中没有锁定msi的版本，所以会引入两个冗余包，分别是<code>@mtfe+msi@1.15.0_@mrn+react-native@3.0.21，@mtfe+msi@1.56.2-beta.0_@mrn+react-native@3.0.21</code></p><p>第三个问题，msi的幽灵依赖</p><p>我们发现因为我们另一个子包B，它根本不直接依赖msi，但是也安装了1.56.2-beta.0这个版本，看了下之前的版本都是1.15.0，所以怀疑是用了兄弟包的幽灵依赖，测试了下将兄弟的包改为1.57.2-beta.0，B的构建中也变成了1.57.2-beta.0，那我们该怎么解决呢，其实他之前可能存在一些依赖的依赖是1.15.0,所以考虑直接在其<code>package.json</code>中显式声明这个1.15.0版本，这样他就不会用兄弟的幽灵依赖</p><p>其他思考🤔</p><p>我翻了下这个子包B的构建，发现从2024年底到2025.7这个包逐渐增大了100KB+，其实在隐形中包一直在变大，而这其实会影响页面的性能，所以业务开发中需要每次关注构建包的体积问题</p><p>基建的升级存在一些中间态，比如这次先尝试一个子包，那就会存在一些尴尬期，和理想态不符合的情况，比如cli存在多版本，依赖存在一些冗余等等，之前升级也遗留了一些没有做完的事情，比如之前的patch最后并没有完全清理掉等等，个人觉得，中间态必然存在，但是需要记得后续让他成为理想态，不然就会存在一个混乱💥的仓库，和永远的阵痛，这也不敢改，那也不敢改</p><p>其实这里面还存在一个问题，公司的一些基建考虑不是很完善，比如他们没有考虑到monorepo的场景，有些依赖其实我们确实可以在根目录去锁包，2而不需要每个子包安装的情况，还有msi这种无法tree-shaking的尴尬设计，随着版本的升级，这玩意体积一直在膨胀，真是忍不住喷啊～，所以基建团队也需要去思考，怎么给业务使用时是一个平和的使用，去真的接触业务的各种组织形式，或者给业务一些最佳实践的组织形式</p><p>2025.07.29补充</p><p>似乎当前metro整体对pnpm的支持不是很好，对monorepo格式下的依赖索引也存在一些问题，之前社区也遗留很多坑，企业中因为最初从某个版本切出，后续自己魔改了很多，后续社区的一些新特性，或者bug修复想合并进去，就很困难</p></div><!----><!----><!----></div></main><footer class="vp-doc-footer" data-v-0d2ffc47 data-v-ac33042a><!--[--><!--]--><!----><div class="contributors" aria-label="Contributors" data-v-ac33042a><span class="contributors-label" data-v-ac33042a>贡献者: </span><span class="contributors-info" data-v-ac33042a><!--[--><!--[--><span class="contributor" data-v-ac33042a>onlylovefish</span><!----><!--]--><!--]--></span></div><nav class="prev-next" data-v-ac33042a><div class="pager" data-v-ac33042a><a class="vp-link no-icon link pager-link prev" href="/yuzhou-site/article/ybszyby4/" data-v-ac33042a data-v-230c3d54><!--[--><span class="desc" data-v-ac33042a>上一页</span><span class="title" data-v-ac33042a>复原IP地址</span><!--]--><!----></a></div><div class="pager" data-v-ac33042a><a class="vp-link no-icon link pager-link next" href="/yuzhou-site/article/a7kim9gv/" data-v-ac33042a data-v-230c3d54><!--[--><span class="desc" data-v-ac33042a>下一页</span><span class="title" data-v-ac33042a>仓库结构</span><!--]--><!----></a></div></nav></footer><!----><!--[--><!--]--></div></div></div><!--[--><!--]--></div></div><!--]--><button style="display:none;" type="button" class="vp-back-to-top" aria-label="back to top" data-v-2cd99c61 data-v-c8556b97><span class="percent" data-allow-mismatch data-v-c8556b97>0%</span><span class="show icon vpi-back-to-top" data-v-c8556b97></span><svg aria-hidden="true" data-v-c8556b97><circle cx="50%" cy="50%" data-allow-mismatch style="stroke-dasharray:calc(0% - 12.566370614359172px) calc(314.1592653589793% - 12.566370614359172px);" data-v-c8556b97></circle></svg></button><footer class="vp-footer" vp-footer data-v-2cd99c61 data-v-74c19f57><!--[--><div class="container" data-v-74c19f57><p class="message" data-v-74c19f57>渔舟 2025</p><!----></div><!--]--></footer><!--[--><!--]--><!--]--></div><!----><!--]--><!--[--><!--]--><!--]--></div><script type="module" src="/yuzhou-site/assets/app-Bg3bfEUT.js" defer></script></body></html>