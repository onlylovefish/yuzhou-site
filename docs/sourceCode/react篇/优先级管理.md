---
title: ä¼˜å…ˆçº§ç®¡ç†
createTime: 2025/09/07 23:27
permalink: /article/ä¼˜å…ˆçº§ç®¡ç†/
---

Reactå†…éƒ¨å¯¹äºä¼˜å…ˆçº§çš„ç®¡ç†, è´¯ç©¿è¿ä½œæµç¨‹çš„ 4 ä¸ªé˜¶æ®µ(ä»è¾“å…¥åˆ°è¾“å‡º), æ ¹æ®å…¶åŠŸèƒ½çš„ä¸åŒ, å¯ä»¥åˆ†ä¸º 3 ç§ç±»å‹:

1. fiberä¼˜å…ˆçº§(LanePriority): ä½äºreact-reconcileråŒ…, ä¹Ÿå°±æ˜¯Lane(è½¦é“æ¨¡å‹).
2. è°ƒåº¦ä¼˜å…ˆçº§(SchedulerPriority): ä½äºscheduleråŒ….
3. ä¼˜å…ˆçº§ç­‰çº§(ReactPriorityLevel) : ä½äºreact-reconcileråŒ…ä¸­çš„SchedulerWithReactIntegration.js, è´Ÿè´£ä¸Šè¿° 2 å¥—ä¼˜å…ˆçº§ä½“ç³»çš„è½¬æ¢.

<strong>ä¼˜å…ˆçº§</strong>
### Fiberä¼˜å…ˆçº§(lanes)

æœ¬è´¨ï¼šæ¯ä¸ªæ›´æ–°ï¼ˆå¦‚ setStateï¼‰ä¼šè¢«åˆ†é…ä¸€ä¸ª Laneï¼ˆè½¦é“ï¼‰ï¼ŒLane å…¶å®å°±æ˜¯ä¸€ä¸ª bitmaskï¼Œä»£è¡¨ä¸åŒçš„ä¼˜å…ˆçº§å’Œç±»å‹ã€‚

ä½œç”¨ï¼šå†³å®šå“ªäº›æ›´æ–°å¯ä»¥è¢«åˆå¹¶ã€æ‰¹é‡å¤„ç†ã€è·³è¿‡ã€å»¶è¿Ÿç­‰ã€‚

å¸¸è§ Laneï¼šSyncLaneã€TransitionLaneã€IdleLaneã€RetryLane ç­‰ã€‚

Laneså†³å®šå“ªäº›è¦åšï¼Œåšé‚£äº›å…ˆï¼Œæ˜¯reactå†…éƒ¨æ›´æ–°å†…å®¹ä¼˜å…ˆçº§



[ReactFiberLane](https://github.com/facebook/react/blob/main/packages/react-reconciler/src/ReactFiberLane.js)ï¼Œè¯¥æ¨¡å‹ä½¿ç”¨32ä½æ¥è¡¨ç¤ºä¼˜å…ˆçº§

<Strong>PSï¼šä¸ºä»€ä¹ˆä½¿ç”¨32ä½è¡¨ç¤ºå‘¢</strong>

1. æ€§èƒ½ä¸å®ç°ç®€æ´
32ä½åœ¨jså¼•æ“ä¸­è¿ç®—é«˜æ•ˆï¼Œä½è¿ç®—å¯ä»¥ç›´æ¥ä½¿ç”¨cpuæŒ‡ä»¤å®Œæˆï¼Œé€Ÿåº¦å¿«ï¼Œç”¨32ä½æ•´æ•°ï¼Œæ¯ä¸€ä½ä»£è¡¨ä¸€ä¸ªlaneï¼Œå¯ä»¥é«˜æ•ˆè¿›è¡Œåˆå¹¶ã€ç­›é€‰ã€ä¼˜å…ˆçº§åˆ¤æ–­ç­‰æ“ä½œ

2. ä¼˜å…ˆçº§æ•°é‡è¶³å¤Ÿ
32ä¸ªlaneè¶³ä»¥è¦†ç›–reactå†…éƒ¨æ‰€æœ‰å¸¸è§çš„ä¼˜å…ˆçº§åœºæ™¯ï¼Œå¦‚åŒæ­¥ã€å¼‚æ­¥ã€äº¤äº’ã€æ¸²æŸ“ã€ç­‰ç­‰

3. å†…å­˜å ç”¨ä½
åªç”¨ä¸€ä¸ª32ä½æ•´æ•°ï¼ˆ4å­—èŠ‚ï¼‰å°±èƒ½è¡¨ç¤ºæ‰€æœ‰laneï¼ŒèŠ‚çœå†…å­˜ã€ä¾¿äºåœ¨fiberæ ‘ä¸­é¢‘ç¹ä¼ é€’å’Œæ¯”è¾ƒ

4. æºç å¯ç»´æŠ¤
32ä½laneè®¾è®¡ç®€å•ç›´è§‚ã€æ˜“äºç»´æŠ¤å’Œæ‰©å±•

### å°ç»“
å…±å®šä¹‰äº†18 ç§è½¦é“(Lane/Lanes)å˜é‡, æ¯ä¸€ä¸ªå˜é‡å æœ‰ 1 ä¸ªæˆ–å¤šä¸ªæ¯”ç‰¹ä½, åˆ†åˆ«å®šä¹‰ä¸ºLaneå’ŒLanesç±»å‹.

æ¯ä¸€ç§è½¦é“(Lane/Lanes)éƒ½æœ‰å¯¹åº”çš„ä¼˜å…ˆçº§, æ‰€ä»¥æºç ä¸­å®šä¹‰äº† 18 ç§ä¼˜å…ˆçº§(LanePriority).

å æœ‰ä½ä½æ¯”ç‰¹ä½çš„Laneå˜é‡å¯¹åº”çš„ä¼˜å…ˆçº§è¶Šé«˜
æœ€é«˜ä¼˜å…ˆçº§ä¸ºSyncLanePriorityå¯¹åº”çš„è½¦é“ä¸ºSyncLane = 0b0000000000000000000000000000001.

æœ€ä½ä¼˜å…ˆçº§ä¸ºOffscreenLanePriorityå¯¹åº”çš„è½¦é“ä¸ºOffscreenLane = 0b1000000000000000000000000000000.

### è°ƒåº¦ä¼˜å…ˆçº§ï¼ˆscheduler prorityï¼‰
[SchedulerPriorities](https://github.com/facebook/react/blob/v17.0.2/packages/scheduler/src/SchedulerPriorities.js)

æœ¬è´¨ï¼šReact å†…éƒ¨è°ƒåº¦ä»»åŠ¡æ—¶ç”¨çš„ä¼˜å…ˆçº§ï¼Œå†³å®šä»»åŠ¡åœ¨ JS äº‹ä»¶å¾ªç¯ä¸­çš„è°ƒåº¦é¡ºåºã€‚

ä½œç”¨ï¼šå†³å®šä»»åŠ¡ä½•æ—¶è¢«æ‰§è¡Œï¼ˆæ¯”å¦‚åŒæ­¥ã€å¼‚æ­¥ã€ç©ºé—²æ—¶ç­‰ï¼‰ã€‚

å¸¸è§å€¼ï¼šImmediatePriorityã€UserBlockingPriorityã€NormalPriorityã€LowPriorityã€IdlePriorityã€‚

scheduler prorityå†³å®šå“ªäº›å…ˆåšï¼Œæ˜¯JSå±‚é¢çš„è°ƒåº¦ä¼˜å…ˆçº§

ä¸ºäº†èƒ½ååŒè°ƒåº¦ä¸­å¿ƒ(scheduleråŒ…)å’Œ fiber æ ‘æ„é€ (react-reconcileråŒ…)ä¸­å¯¹ä¼˜å…ˆçº§çš„ä½¿ç”¨, åˆ™éœ€è¦è½¬æ¢SchedulerPriorityå’ŒLanePriority, è½¬æ¢çš„æ¡¥æ¢æ˜¯ReactPriorityLevel

### ReactPriorityLevel

è¯¦ç»†å®šä¹‰è§```getInternalReactConstants```

è½¬æ¢ä¸»è¦ä¸€ä¸ªåœ¨schedulerä¸­çš„```getCurrentPriorityLevel```
å¤§ä½“è½¬æ¢ä¼ªä»£ç å¦‚ä¸‹
```js
export function getCurrentPriorityLevel(): ReactPriorityLevel {
  switch (Scheduler_getCurrentPriorityLevel()) {
    case Scheduler_ImmediatePriority:
      return ImmediatePriority;
    case Scheduler_UserBlockingPriority:
      return UserBlockingPriority;
    case Scheduler_NormalPriority:
      return NormalPriority;
    case Scheduler_LowPriority:
      return LowPriority;
    case Scheduler_IdlePriority:
      return IdlePriority;
    default:
      invariant(false, 'Unknown priority level.');
  }
}

function reactPriorityToSchedulerPriority(reactPriorityLevel) {
  switch (reactPriorityLevel) {
    case ImmediatePriority:
      return Scheduler_ImmediatePriority;
    case UserBlockingPriority:
      return Scheduler_UserBlockingPriority;
    case NormalPriority:
      return Scheduler_NormalPriority;
    case LowPriority:
      return Scheduler_LowPriority;
    case IdlePriority:
      return Scheduler_IdlePriority;
    default:
      invariant(false, 'Unknown priority level.');
  }
}
```

### reactç®—æ³•ï¼ˆä½è¿ç®—ï¼‰

![alt text](./img/ä½è¿ç®—è¯´æ˜.png)

ES5è§„èŒƒä¸­ä½è¿ç®—å·¦å³æ“ä½œæ•°éƒ½è½¬æ¢ä¸ºæœ‰ç¬¦å·32ä½æ•´å‹ï¼Œä¸”è¿”å›ç»“æœä¹Ÿæ˜¯æœ‰ç¬¦å·32ä½æ•´å‹

- å½“æ“ä½œæ•°æ˜¯æµ®ç‚¹æ•°æ—¶é¦–å…ˆä¼šè¢«è½¬æ¢ä¸ºæ•´å‹ï¼Œå†è¿›è¡Œä½è¿ç®—
- å½“æ“ä½œæ•°è¿‡å¤§ï¼Œè¶…è¿‡äº†Int32èŒƒå›´, è¶…è¿‡çš„éƒ¨åˆ†ä¼šè¢«æˆªå–

ä¸Šè¿°çŸ¥è¯†ç‚¹å›é¡¾ï¼Œè¦ç‚¹å¦‚ä¸‹

- ä½è¿ç®—åªåœ¨æ•´æ•°å˜é‡ä¹‹é—´è¿›è¡Œè¿ç®—
- js ä¸­çš„Numberç±»å‹åœ¨åº•å±‚éƒ½æ˜¯ä»¥æµ®ç‚¹æ•°(å‚è€ƒ IEEE754 æ ‡å‡†)è¿›è¡Œå­˜å‚¨.
- js ä¸­æ‰€æœ‰çš„æŒ‰ä½æ“ä½œç¬¦çš„æ“ä½œæ•°éƒ½ä¼šè¢«è½¬æˆè¡¥ç ï¼ˆtwo's complementï¼‰å½¢å¼çš„æœ‰ç¬¦å·32ä½æ•´æ•°

æ‰€ä»¥åœ¨ js ä¸­ä½¿ç”¨ä½è¿ç®—æ—¶, æœ‰ 2 ç§æƒ…å†µä¼šé€ æˆç»“æœå¼‚å¸¸:

1. æ“ä½œæ•°ä¸ºæµ®ç‚¹å‹(è™½ç„¶åº•å±‚éƒ½æ˜¯æµ®ç‚¹å‹, æ­¤å¤„ç†è§£ä¸ºæ˜¾ç¤ºæ€§çš„æµ®ç‚¹å‹)
```bash
è½¬æ¢æµç¨‹: æµ®ç‚¹æ•° -> æ•´æ•°(ä¸¢å¼ƒå°æ•°ä½) -> ä½è¿ç®—
```
2. æ“ä½œæ•°çš„å¤§å°è¶…è¿‡```Int32```èŒƒå›´```(-2^31 ~ 2^31-1)```. è¶…è¿‡èŒƒå›´çš„äºŒè¿›åˆ¶ä½ä¼šè¢«æˆªæ–­, å–ä½ä½32bit.
```js
Before: 11100110111110100000000000000110000000000001
After:              10100000000000000110000000000001
```
å¦å¤–ç”±äº js è¯­è¨€çš„éšå¼è½¬æ¢, å¯¹éNumberç±»å‹ä½¿ç”¨ä½è¿ç®—æ“ä½œç¬¦æ—¶ä¼šå‘ç”Ÿéšå¼è½¬æ¢, ç›¸å½“äºå…ˆä½¿ç”¨Number(xxx)å°†å…¶è½¬æ¢ä¸ºnumberç±»å‹, å†è¿›è¡Œä½è¿ç®—:
```js
'str' >>> 0; //  ===> Number('str') >>> 0  ===> NaN >>> 0 = 0
```

#### åŸºæœ¬ä½¿ç”¨

1. æšä¸¾å±æ€§
```js
const A = 1 << 0; // 0b00000001
const B = 1 << 1; // 0b00000010
const C = 1 << 2; // 0b00000100
```

2. ä½æ©ç 

é€šè¿‡ä½ç§»å®šä¹‰çš„ä¸€ç»„æšä¸¾å¸¸é‡, å¯ä»¥åˆ©ç”¨ä½æ©ç çš„ç‰¹æ€§, å¿«é€Ÿæ“ä½œè¿™äº›æšä¸¾äº§é‡(å¢åŠ , åˆ é™¤, æ¯”è¾ƒ).
```js

// å±æ€§å¢åŠ |
// ABC = A | B | C
// å±æ€§åˆ é™¤& ~
// AB = ABC & ~C
// å±æ€§æ¯”è¾ƒ
// AB å½“ä¸­åŒ…å« B: AB & B === B
// AB å½“ä¸­ä¸åŒ…å« C: AB & C === 0
// A å’Œ B ç›¸ç­‰: A === B

const A = 1 << 0; // 0b00000001
const B = 1 << 1; // 0b00000010
const C = 1 << 2; // 0b00000100

// å¢åŠ å±æ€§
const ABC = A | B | C; // 0b00000111
// åˆ é™¤å±æ€§
const AB = ABC & ~C; // 0b00000011

// å±æ€§æ¯”è¾ƒ
// 1. ABå½“ä¸­åŒ…å«B
console.log((AB & B) === B); // true
// 2. ABå½“ä¸­ä¸åŒ…å«C
console.log((AB & C) === 0); // true
// 3. Aå’ŒBç›¸ç­‰
console.log(A === B); // false
```

åœ¨reactä¸­æœ‰å¤šä¸ªåœ°æ–¹ç”¨åˆ°äº†ä½è¿ç®—ï¼Œä¸¾å‡ ä¸ªğŸŒ°

#### lanesæ¨¡å‹

åœ¨laneä¸­å˜é‡åªåˆ—å‡ºäº† 31 ä½, ç”±äº js ä¸­ä½è¿ç®—éƒ½ä¼šè½¬æ¢æˆInt32(ä¸Šæ–‡å·²ç»è§£é‡Š), æœ€å¤šä¸º 32 ä½, ä¸”æœ€é«˜ä½æ˜¯ç¬¦å·ä½. æ‰€ä»¥é™¤å»ç¬¦å·ä½, æœ€å¤šåªæœ‰ 31 ä½å¯ä»¥å‚ä¸è¿ç®—.
<strong>getHighestPriorityLaneï¼šåˆ†ç¦»å‡ºæœ€é«˜ä¼˜å…ˆçº§</strong>
```js

export function getHighestPriorityLane(lanes: Lanes): Lane {
  return lanes & -lanes;
}
```
é€šè¿‡lanes & -laneså¯ä»¥åˆ†ç¦»å‡ºæ‰€æœ‰æ¯”ç‰¹ä½ä¸­æœ€å³è¾¹çš„ 1, å…·ä½“æ¥è®²:

```bash

å‡è®¾ lanes(InputDiscreteLanes) = 0b0000000000000000000000000011000
é‚£ä¹ˆ -lanes = 0b1111111111111111111111111101000
æ‰€ä»¥ lanes & -lanes = 0b0000000000000000000000000001000
ç›¸æ¯”æœ€åˆçš„ InputDiscreteLanes, åˆ†ç¦»å‡ºæ¥äº†æœ€å³è¾¹çš„1
é€šè¿‡ lanes çš„å®šä¹‰, æ•°å­—è¶Šå°çš„ä¼˜å…ˆçº§è¶Šé«˜, æ‰€ä»¥æ­¤æ–¹æ³•å¯ä»¥è·å–æœ€é«˜ä¼˜å…ˆçº§çš„lane
```

#### æ‰§è¡Œä¸Šä¸‹æ–‡ExecutionContext
ExecutionContextå®šä¹‰ä¸react-reconcileråŒ…ä¸­, ä»£è¡¨reconcileråœ¨è¿è¡Œæ—¶çš„ä¸Šä¸‹æ–‡çŠ¶æ€(åœ¨reconciler æ‰§è¡Œä¸Šä¸‹æ–‡ç« èŠ‚ä¸­æ·±å…¥è§£è¯», æ­¤å¤„ä»‹ç»ä½è¿ç®—çš„åº”ç”¨).

```js
export const NoContext = /*             */ 0b0000000;
const BatchedContext = /*               */ 0b0000001;
const EventContext = /*                 */ 0b0000010;
const DiscreteEventContext = /*         */ 0b0000100;
const LegacyUnbatchedContext = /*       */ 0b0001000;
const RenderContext = /*                */ 0b0010000;
const CommitContext = /*                */ 0b0100000;
export const RetryAfterError = /*       */ 0b1000000;

// ...

// Describes where we are in the React execution stack
let executionContext: ExecutionContext = NoContext;
```