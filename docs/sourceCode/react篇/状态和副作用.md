---
title: 状态和副作用
createTime: 2025/11/09 18:15:13
permalink: /article/lv2hr4j8/
---
本节主要分析fiber如果影响最终的渲染

Fiber树众多属性，有两块内容
1. fiber节点的自身状态，在renderRootSync【Concurrent】阶段，为子节点提供确定的输入数据，影响子节点生成
2. fiber节点的副作用：在commitRoot阶段，如果fiber被标记有副作用，则副作用相关函数会（同步/异步）被调用

```js
export type Fiber = {|
  // 1. fiber节点自身状态相关
  pendingProps: any,
  memoizedProps: any,
  updateQueue: mixed,
  memoizedState: any,

  // 2. fiber节点副作用(Effect)相关
  flags: Flags,
  subtreeFlags: Flags, // v17.0.2未启用
  deletions: Array<Fiber> | null, // v17.0.2未启用
 
|};
```

## pendingProps
fiber.pendingProps: 输入属性, 从ReactElement对象传入的 props. 它和fiber.memoizedProps比较可以得出属性是否变动.

## memoizedProps
fiber.memoizedProps: 上一次生成子节点时用到的属性, 生成子节点之后保持在内存中. 向下生成子节点之前叫做pendingProps, 生成子节点之后会把pendingProps赋值给memoizedProps用于下一次比较.pendingProps和memoizedProps比较可以得出属性是否变动

## updateQueue 的主要功能
1. 管理 hooks 的副作用链表
对于函数组件，updateQueue 里保存了 hooks 的 effect 环形链表（如 useEffect、useLayoutEffect 等）。

结构通常是 { lastEffect: Effect | null }，每个 effect 通过 next 字段串成环。

2. 管理 hooks 的 state 更新队列

对于 useState、useReducer 等 hooks，updateQueue 还会存储 state 的更新队列（链表），用于调度和合并多次 setState。

3. 存储其它 hooks 相关的数据
例如 stores（用于 useSyncExternalStore）、memoizedState（hooks 链表头）等。

## memoizedState
fiber.memoizedState: 上一次生成子节点之后保持在内存中的局部状态.